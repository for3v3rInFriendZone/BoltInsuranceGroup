package com.bolt.insurance.group.rule

import com.bolt.insurance.group.app.model.Insurance
import com.bolt.insurance.group.app.model.Risk
import com.bolt.insurance.group.app.model.Price
import com.bolt.insurance.group.app.model.Subgroup
import com.bolt.insurance.group.app.model.Type
import com.bolt.insurance.group.app.service.RiskService
import com.bolt.insurance.group.app.model.User
import java.util.Date

declare AlreadyProcessed
end

rule "ceo paket"
no-loop true
dialect "mvel"
salience 2
	when
		not AlreadyProcessed()
		$insurance : Insurance()
		$risk : (Risk(name == "starost") from $insurance.risks) 
			&& (Risk(name == "region") from $insurance.risks)
			&& (Risk(name == "trajanje") from $insurance.risks)
			&& (Risk(name == "sport") from $insurance.risks)
			&& (Risk(name == "povrsina") from $insurance.risks)
			&& (Risk(name == "starost_stana") from $insurance.risks)
			&& (Risk(name == "procenjena_vrednost") from $insurance.risks)
			&& (Risk(name == "vrsta_osiguranja") from $insurance.risks)
			&& (Risk(name == "paket") from $insurance.risks)
	then
		
		insert(new AlreadyProcessed());
end

rule "Osnovno osiguranje"
dialect "mvel"
salience 1
	when
		not AlreadyProcessed()
		$insurance : Insurance()
		$risk : (Risk(name == "starost") from $insurance.risks) 
			&& (Risk(name == "region") from $insurance.risks)
			&& (Risk(name == "trajanje") from $insurance.risks)
	then
		System.out.println("pogodio pravilo");
		for(Risk r : $insurance.risks){
			if(r.name == "starost"){
				System.out.println("starost");
				System.out.println($insurance.amount);
				for(User u : $insurance.users){
					System.out.println("korisnik");
					System.out.println($insurance.amount);
					modify($insurance){
						setAmount($insurance.amount + u.subgroup.coefficient * r.price.value);
					}
				}
			}else if(r.name == "region"){
				System.out.println("region");
				System.out.println($insurance.amount);
				modify($insurance){
					setAmount($insurance.amount + r.subgroup.coefficient * r.price.value);
				}
			}else if(r.name == "trajanje"){
				System.out.println("trajanje");	
				System.out.println($insurance.amount);
				modify($insurance){
					setAmount($insurance.amount + r.price.value * $insurance.days);
				}
			}
		}
		System.out.println("Br korisnika" + $insurance.users.size);
		if($insurance.users.size() > 2){
			System.out.println("Cena :" + $insurance.amount);
			modify($insurance){
				setAmount($insurance.amount - $insurance.amount * 0.2);
			}
		}
		insert(new AlreadyProcessed());
end